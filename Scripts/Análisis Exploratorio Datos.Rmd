---
title: "Análisis Exploratorio Datos"
output: html_document
---

# Análisis Exploratorio de los Datos

## Cargar librerías

```{r}
library(tidyverse)
library(viridis)
```

## Leer datos

```{r}
data <- read.csv("/DatosJon/UPNA/3º Ciencia de Datos/S6/Analisis Multivariante y Visualizacion de Datos/Trabajo/Datos/Vehicle_Collisions.csv")
```

```{r}
data <- read.csv("C:/Users/ruben/OneDrive/Escritorio/UPNA/CIENCIA DE DATOS/6ºSemestre/AnalisisMultivarianteVisualizacionDatos/Trabajo Final/Motor_Vehicle_Collisions_-_Crashes.csv")
View(data)
```

## Contributing Factor Vehicle

```{r}
contr_v1 <- data |> 
  select(CONTRIBUTING.FACTOR.VEHICLE.1) |> 
  mutate(CONTR_V1 = CONTRIBUTING.FACTOR.VEHICLE.1) |> 
  filter(if_any(everything(), ~ . != "")) |> 
  count(CONTR_V1, name='FREQUENCY')

contr_v2 <- data |> 
  select(CONTRIBUTING.FACTOR.VEHICLE.2) |> 
  mutate(CONTR_V2 = CONTRIBUTING.FACTOR.VEHICLE.2) |> 
  filter(if_any(everything(), ~ . != "")) |> 
  count(CONTR_V2, name='FREQUENCY')

contr_v3 <- data |> 
  select(CONTRIBUTING.FACTOR.VEHICLE.3) |> 
  mutate(CONTR_V3 = CONTRIBUTING.FACTOR.VEHICLE.3) |> 
  filter(if_any(everything(), ~ . != "")) |> 
  count(CONTR_V3, name='FREQUENCY')

contr_v4 <- data |> 
  select(CONTRIBUTING.FACTOR.VEHICLE.4) |> 
  mutate(CONTR_V4 = CONTRIBUTING.FACTOR.VEHICLE.4) |> 
  filter(if_any(everything(), ~ . != "")) |> 
  count(CONTR_V4, name='FREQUENCY')

contr_v5 <- data |> 
  select(CONTRIBUTING.FACTOR.VEHICLE.5) |> 
  mutate(CONTR_V5 = CONTRIBUTING.FACTOR.VEHICLE.5) |> 
  filter(if_any(everything(), ~ . != "")) |> 
  count(CONTR_V5, name='FREQUENCY')
```

```{r}
contr_factors_cleaned <- data |> 
  select(starts_with("CONTRIBUTING.FACTOR.VEHICLE")) |>  # Selecciona todas las columnas relevantes
  pivot_longer(cols = everything(), names_to = "VEHICLE", values_to = "FACTOR") |>  # Convierte a formato largo
  filter(FACTOR != "") |>  # Filtra valores vacíos  
  mutate(FACTOR = recode(FACTOR,
    "Cell Phone (hand-Held)" = "Cell Phone (hand-held)",
    "Drugs (Illegal)" = "Drugs (illegal)",
    "Illnes" = "Illness",
    "Other Electronic Device" = "Other Devices",
    "Drugs (illegal)" = "Drugs (illegal)",
    "Unspecified" = "Unspecified",
    "Pedestrian/Bicyclist/Other Pedestrian Error/Confusion" = "Pedestrian Error/Confusion",
    "Aggressive Driving/Road Rage" = "Aggressive Driving"
  )) |> 
  count(FACTOR, name = "FREQUENCY") |>  # Cuenta ocurrencias de cada factor
  arrange(desc(FREQUENCY))  # Ordena de mayor a menor

```

```{r}
contr_factors_cleaned |> 
  arrange(FREQUENCY)
```

```{r}
contr_factors_cleaned |> 
  ggplot(aes(x = reorder(FACTOR, FREQUENCY), y = FREQUENCY)) + 
  geom_bar(stat = "identity", fill = "steelblue") + 
  # coord_flip() +  # Rota el gráfico para mejor visualización
  labs(title = "Total Frecuencia de Factores Contribuyentes",
       x = "Factor Contribuyente",
       y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=60, hjust=1,size=6),
        axis.title = element_text(size=10),
        title = element_text(size=12),
        axis.title.x=element_blank(),
        legend.title = element_blank()
        )
```

### Vamos a no considerar el factor 'Unspecified'

```{r}
contr_factors_cleaned |> 
  filter(FACTOR != 'Unspecified', FREQUENCY > 50000) |> 
  ggplot(aes(x = reorder(FACTOR, FREQUENCY), y = FREQUENCY, fill = FREQUENCY)) + 
  geom_bar(stat = "identity") + 
  # coord_flip() +  # Rota el gráfico para mejor visualización
  scale_fill_viridis_c(option = "plasma", name = "Frecuencia") +  # Usa la paleta 'plasma' para mejor contraste
  labs(title = "Frecuencia de Factores Contribuyentes en Accidentes",
       x = "Factor Contribuyente",
       y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=60, hjust=1,size=6),
        axis.text.y = element_text(size=7),
        axis.title = element_text(size=12),
        title = element_text(size=14, face="bold"),
        legend.position = "right")  # Mueve la leyenda a la derecha

contr_factors_cleaned |> 
  filter(FACTOR != 'Unspecified', FREQUENCY < 50000) |> 
  ggplot(aes(x = reorder(FACTOR, FREQUENCY), y = FREQUENCY, fill = FREQUENCY)) + 
  geom_bar(stat = "identity") + 
  # coord_flip() +  # Rota el gráfico para mejor visualización
  scale_fill_viridis_c(option = "plasma", name = "Frecuencia") +  # Usa la paleta 'plasma' para mejor contraste
  labs(title = "Frecuencia de Factores Contribuyentes en Accidentes",
       x = "Factor Contribuyente",
       y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=60, hjust=1,size=6),
        axis.text.y = element_text(size=7),
        axis.title = element_text(size=12),
        title = element_text(size=14, face="bold"),
        legend.position = "right")  # Mueve la leyenda a la derecha

```

## Vehicle Type Code:

### Jon

```{r}
vehicle_type_cleaned <- data |> 
  select(starts_with("VEHICLE.TYPE.CODE.1")) |>  
  pivot_longer(cols = everything(), names_to = "TYPE", values_to = "FACTOR") |> 
  filter(FACTOR != "") |>  
  count(FACTOR, name = "FREQUENCY") |>
  arrange(desc(FREQUENCY))

```

Paso 1: Calcular la Similitud Entre Todos los Tipos de Vehículos

```{r}
library(stringdist)

# Extraer los nombres únicos de los vehículos
vehicle_types <- unique(vehicle_type_cleaned$FACTOR)

# Crear una matriz de distancias entre todos los nombres
dist_matrix <- stringdistmatrix(vehicle_types, vehicle_types, method = "jw") 

# Convertir la matriz en un formato adecuado para clustering
rownames(dist_matrix) <- vehicle_types
colnames(dist_matrix) <- vehicle_types
```

Paso 2: Aplicar Clustering para Encontrar Grupos Similares

```{r}
# Realizar clustering jerárquico
hc <- hclust(as.dist(dist_matrix), method = "ward.D2")

# Elegir un número de clusters basado en la distancia (puedes ajustar `h`)
clusters <- cutree(hc, h = 0.25)  # Ajusta h entre 0.1 y 0.3 según el resultado

# Crear un dataframe con la asignación de clusters
df_clusters <- data.frame(VEHICLE_TYPE = vehicle_types, CLUSTER = clusters)
```

Paso 3: Unificar los Tipos de Vehículos en una Nueva Columna

```{r}
# Seleccionar un nombre representativo para cada cluster
df_clusters <- df_clusters |> 
  group_by(CLUSTER) |> 
  mutate(STANDARD_NAME = first(VEHICLE_TYPE))  # Puedes cambiar la estrategia de selección

# Unir esta información con los datos originales
vehicle_type_cleaned <- vehicle_type_cleaned |> 
  left_join(df_clusters, by = c("FACTOR" = "VEHICLE_TYPE")) |> 
  mutate(FACTOR = STANDARD_NAME) |> 
  select(-CLUSTER, -STANDARD_NAME)

# Contar la frecuencia de cada tipo unificado
vehicle_type_final <- vehicle_type_cleaned |> 
  count(FACTOR, name = "FREQUENCY") |> 
  arrange(desc(FREQUENCY))
```

### Rubo

```{r}
dataVT <- data |> 
  dplyr::select(VEHICLE.TYPE.CODE.1, VEHICLE.TYPE.CODE.2, VEHICLE.TYPE.CODE.3, VEHICLE.TYPE.CODE.4, VEHICLE.TYPE.CODE.5)

missing_data <- dataVT %>%
  summarise(across(everything(), ~ sum(is.na(.) | (is.numeric(.) & is.nan(.)) | .=="")))

missing_data_long <- missing_data %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Missing_Count")


# Crear el gráfico de barras
ggplot(missing_data_long, aes(x = Variable, y = Missing_Count, fill = Variable)) +
  geom_col() +  # Gráfico de barras
  labs(
    x = "Variable",  # Etiqueta del eje X
    y = "Número de valores problemáticos",  # Etiqueta del eje Y
    title = "Valores faltantes, no numéricos o cadenas vacías por variable"  # Título
  ) +
  theme_minimal() +  # Tema minimalista
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotar etiquetas del eje X
```
